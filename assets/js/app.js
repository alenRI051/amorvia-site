let state={trust:60,stress:40,current:null,scenarios:[],lang:'en',bgPack:'default',i18n:null,resources:null,sw:false,data:false};
function t(k){return (state.i18n&&state.i18n[state.lang]&&state.i18n[state.lang][k])||k;}
function setReady(){const p=document.getElementById('readyPill');if(!p)return;if(state.data&&state.sw){p.textContent=t('ready')+' ✅';}else if(state.data){p.textContent=t('ready')+' ✅ ('+t('online_only')+')';}}
function setError(m){const p=document.getElementById('readyPill');if(p){p.textContent='Error: '+m; p.style.background='#3b0b0b';p.style.borderColor='#7f1d1d';}}
async function load(){try{state.i18n=await (await fetch('assets/data/i18n.json')).json();state.resources=await (await fetch('assets/data/resources_hr.json')).json();applyI18n();await loadScenarios();state.data=true;setReady();}catch(e){setError('data');console.error(e);}buildSidebar();select(state.scenarios[0]?.id||null);try{if('serviceWorker'in navigator){await navigator.serviceWorker.register('service-worker.js');state.sw=true;setReady();}}catch(e){setReady();}document.getElementById('langSel').addEventListener('change',async e=>{state.lang=e.target.value;applyI18n();await loadScenarios();buildSidebar();const cur=state.current?.id||state.scenarios[0].id;select(cur);});document.getElementById('bgPack').addEventListener('change',e=>{state.bgPack=e.target.value;if(state.current)select(state.current.id);});document.getElementById('crisisBtn').addEventListener('click',openCrisis);document.getElementById('crisisClose').addEventListener('click',closeCrisis);}
async function loadScenarios(){const file=state.lang==='hr'?'assets/data/scenarios_hr.json':'assets/data/scenarios.json';try{state.scenarios=await (await fetch(file)).json();}catch{state.scenarios=await (await fetch('assets/data/scenarios.json')).json();}}
function applyI18n(){document.getElementById('betaLabel').textContent=t('beta');document.getElementById('pwaLabel').textContent=t('pwa_ready');document.getElementById('langLabel').textContent=t('lang');document.getElementById('bgPackLabel').textContent=t('bg_pack');const b=document.getElementById('crisisBtn');if(b)b.textContent=t('crisis_hub');}
function buildSidebar(){const sb=document.getElementById('sidebar');sb.innerHTML=`<div style="font-weight:800;margin-bottom:10px">${t('scenarios')}</div>`;state.scenarios.forEach(sc=>{const d=document.createElement('div');d.className='scenario-item';d.innerHTML=`<div style="font-weight:700">${sc.title}</div><div style="opacity:.75;font-size:13px">${sc.summary}</div>`;d.onclick=()=>select(sc.id);sb.appendChild(d);});}
function tintCharacter(el,a){el.style.filter=`hue-rotate(${a}deg) saturate(1.2)`;}
function select(id){const sc=state.scenarios.find(s=>s.id===id)||state.scenarios[0];state.current=sc;document.getElementById('title').textContent=sc.title;document.getElementById('summary').textContent=sc.summary;const prefix=state.bgPack==='dark'?'assets/backgrounds/dark_':'assets/backgrounds/';document.getElementById('bg').style.backgroundImage=`url(${prefix}${sc.background})`;const choices=document.getElementById('choices');choices.innerHTML='';const header=document.querySelector('.card div[style*="font-weight:700"][style*="margin-bottom:8px"]');if(header)header.textContent=t('choose_path');sc.choices.forEach(ch=>{const btn=document.createElement('button');btn.className='button';btn.textContent=ch.text;btn.onclick=()=>applyEffect(ch.effect);choices.appendChild(btn);});tintCharacter(document.getElementById('charA'),0);tintCharacter(document.getElementById('charB'),300);const cards=document.querySelectorAll('.card');if(cards[1]){cards[1].querySelector('div[style*="font-weight:700"]').textContent=t('relationship_stats');const labels=cards[1].querySelectorAll('div');labels[1].textContent=t('trust');labels[3].textContent=t('stress');}}
function clamp(n,min,max){return Math.max(min,Math.min(max,n));}
function applyEffect(e){state.trust=clamp(state.trust+(e.trust||0),0,100);state.stress=clamp(state.stress+(e.stress||0),0,100);document.getElementById('trust').style.width=state.trust+'%';document.getElementById('stress').style.width=state.stress+'%';const a=document.getElementById('charA');const b=document.getElementById('charB');a.style.filter=`hue-rotate(${(100-state.stress)}deg) saturate(1.2)`;b.style.filter=`hue-rotate(${state.trust}deg) saturate(1.2)`;}
function openCrisis(){const m=document.getElementById('crisisModal');m.style.display='flex';document.getElementById('crisisTitle').textContent=t('crisis_hub');document.getElementById('countryLabel').textContent=t('country');document.getElementById('crisisClose').textContent=t('close');const list=document.getElementById('crisisList');list.innerHTML=`<div style="opacity:.8;margin-bottom:6px">${t('resources')}</div>`;const items=(state.resources&&state.resources.resources)||[];items.forEach(r=>{const a=document.createElement('a');a.href=r.url;a.target='_blank';a.rel='noopener';a.className='scenario-item';a.style.display='block';a.textContent=r.name+' — '+r.url;list.appendChild(a);});}
function closeCrisis(){document.getElementById('crisisModal').style.display='none';}
load();